<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="com.prac.s1.board.notice.NoticeDAO">
       <select id="list" parameterType ="Pager" resultType="NoticeDTO">
         SELECT * FROM
          (SELECT ROWNUM R, B.* FROM 
              (SELECT * FROM NOTICE WHERE 
                NUM>0 
                 AND <choose>
                       <when test="kind=='col1'">
                          TITLE
                       </when>
                       <when test="kind=='col2'">
                          CONTENTS
                       </when>
                       <otherwise>
                          WRITER
                       </otherwise>
                    </choose>
                  LIKE '%' || #{search} || '%'
                  ORDER BY NUM DESC) B)
      WHERE R BETWEEN #{startRow} AND #{lastRow}
      </select>
   
       <select id="detail"  parameterType="NoticeDTO" resultMap="detailResult">
         SELECT N.*,NF.*
         FROM NOTICE N
         LEFT JOIN
         NOTICEFILE NF
         ON (N.NUM =NF.NUM)
         WHERE N.NUM=#{num}
      </select>
      		<resultMap type="NoticeDTO" id="detailResult">
			<id column="num" property="num"/>
			<result column="title" property="title"/>
			<result column="contents" property="contents"/>
			<result column="writer" property="writer"/>
			<result column="regDate" property="regDate"/>
			<result column="hit" property="hit"/>
			
			<collection property="fileDTOs" javaType="List" ofType="NoticeFileDTO"><!-- 자바타입에서 noticefiledto가 아니다 그건 제네릭임 여기서 타입은 list -->
				<id column="fileNum" property="fileNum"/> 		<!-- num은 위에서 써줬기 때문에 안써줘도 된다 -->
				<result column="fileName" property="fileName"/>
				<result column="oriName" property="oriName"/>
			</collection>
		
		</resultMap>
 
 	<insert id="addFile" parameterType="BoardFileDTO" >
          INSERT INTO NOTICEFILE (FILENUM, NUM, FILENAME, ORINAME)
          VALUES (FILE_SEQ.NEXTVAL, #{num}, #{fileName}, #{oriName})
       </insert>
       
      <insert id="add" parameterType="NoticeDTO">
         <selectKey keyProperty="num" order="BEFORE" resultType="Long">
            SELECT NOTICE_SEQ.NEXTVAL FROM DUAL
         </selectKey>
         INSERT INTO NOTICE(NUM, TITLE, CONTENTS, WRITER, REGDATE, HIT)
         VALUES(#{num}, #{title},#{contents},#{writer},SYSDATE,0)
      </insert>
      
      <update id="update" parameterType="NoticeDTO">
         UPDATE NOTICE SET TITLE = #{title},CONTENTS=#{contents}   where num=#{num}
      </update>
   
      <delete id="delete" parameterType="NoticeDTO">
         DELETE NOTICE WHERE NUM=#{num}
      </delete>
      
      <select id="total" resultType="Long" parameterType="Pager">
      SELECT COUNT(NUM) FROM NOTICE
      WHERE    NUM>0 
                 AND <choose>
                       <when test="kind=='col1'">
                          NUM
                       </when>
                       <when test="kind=='col2'">
                          CONTENTS
                       </when>
                       <otherwise>
                          WRITER
                       </otherwise>
                    </choose>
                  LIKE '%' || #{search} || '%'
      </select>
    </mapper>